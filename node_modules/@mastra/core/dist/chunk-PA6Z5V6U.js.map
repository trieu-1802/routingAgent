{"version":3,"sources":["../src/ai-tracing/serialization.ts"],"names":["cleaned"],"mappings":"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","file":"chunk-PA6Z5V6U.js","sourcesContent":["/**\n * Bounded serialization utilities for AI tracing.\n *\n * These utilities prevent memory issues by enforcing strict limits on\n * string lengths, array sizes, object depths, and total output size.\n * They are designed to be used across all tracing/telemetry systems.\n */\n\n/**\n * Configuration limits for serialization.\n * These defaults are intentionally conservative to prevent OOM issues.\n */\nexport interface SerializationLimits {\n  /** Maximum characters for any single attribute string (default: 1024) */\n  maxAttrChars: number;\n  /** Maximum depth for recursive serialization (default: 6) */\n  maxDepth: number;\n  /** Maximum object keys to serialize (default: 50) */\n  maxKeys: number;\n  /** Maximum array elements to serialize (default: 50) */\n  maxArrayItems: number;\n  /** Maximum total output characters (default: 8192) */\n  maxTotalChars: number;\n}\n\nexport const DEFAULT_SERIALIZATION_LIMITS: SerializationLimits = Object.freeze({\n  maxAttrChars: 1024,\n  maxDepth: 6,\n  maxKeys: 50,\n  maxArrayItems: 50,\n  maxTotalChars: 8192,\n});\n\n/**\n * Hard-cap any string to prevent unbounded growth.\n */\nexport function truncateString(s: string, maxChars: number): string {\n  if (s.length <= maxChars) return s;\n  return s.slice(0, maxChars) + '…[truncated]';\n}\n\n/**\n * Default keys to strip from objects during deep cleaning.\n * These are typically internal/sensitive fields that shouldn't be traced.\n */\nexport const DEFAULT_KEYS_TO_STRIP = new Set([\n  'logger',\n  'experimental_providerMetadata',\n  'providerMetadata',\n  'steps',\n  'tracingContext',\n]);\n\n/** Empty set for when you don't want to strip any keys */\nconst NO_KEYS_TO_STRIP = new Set<string>();\n\nexport interface DeepCleanOptions {\n  keysToStrip?: Set<string>;\n  maxDepth?: number;\n  maxStringLength?: number;\n  maxArrayLength?: number;\n  maxObjectKeys?: number;\n}\n\n/**\n * Recursively cleans a value by removing circular references, stripping problematic keys,\n * and enforcing size limits on strings, arrays, and objects.\n *\n * This is used by AI tracing spans to sanitize input/output data before storing.\n *\n * @param value - The value to clean (object, array, primitive, etc.)\n * @param options - Optional configuration for cleaning behavior\n * @returns A cleaned version of the input with size limits enforced\n */\nexport function deepClean(value: any, options: DeepCleanOptions = {}): any {\n  const {\n    keysToStrip = DEFAULT_KEYS_TO_STRIP,\n    maxDepth = DEFAULT_SERIALIZATION_LIMITS.maxDepth,\n    maxStringLength = DEFAULT_SERIALIZATION_LIMITS.maxAttrChars,\n    maxArrayLength = DEFAULT_SERIALIZATION_LIMITS.maxArrayItems,\n    maxObjectKeys = DEFAULT_SERIALIZATION_LIMITS.maxKeys,\n  } = options;\n\n  const seen = new WeakSet<any>();\n\n  function helper(val: any, depth: number): any {\n    if (depth > maxDepth) {\n      return '[MaxDepth]';\n    }\n\n    // Handle primitives\n    if (val === null || val === undefined) {\n      return val;\n    }\n\n    // Handle strings - enforce length limit\n    if (typeof val === 'string') {\n      return truncateString(val, maxStringLength);\n    }\n\n    // Handle other non-object primitives explicitly\n    if (typeof val === 'number' || typeof val === 'boolean') {\n      return val;\n    }\n    if (typeof val === 'bigint') {\n      return `${val}n`;\n    }\n    if (typeof val === 'function') {\n      return '[Function]';\n    }\n    if (typeof val === 'symbol') {\n      return val.description ? `[Symbol(${val.description})]` : '[Symbol]';\n    }\n\n    // Handle Date objects - preserve as-is\n    if (val instanceof Date) {\n      return val;\n    }\n\n    // Handle Errors specially - preserve name and message\n    if (val instanceof Error) {\n      return {\n        name: val.name,\n        message: val.message ? truncateString(val.message, maxStringLength) : undefined,\n      };\n    }\n\n    // Handle circular references\n    if (typeof val === 'object') {\n      if (seen.has(val)) {\n        return '[Circular]';\n      }\n      seen.add(val);\n    }\n\n    // Handle arrays - enforce length limit\n    if (Array.isArray(val)) {\n      const limitedArray = val.slice(0, maxArrayLength);\n      const cleaned = limitedArray.map(item => helper(item, depth + 1));\n      if (val.length > maxArrayLength) {\n        cleaned.push(`[…${val.length - maxArrayLength} more items]`);\n      }\n      return cleaned;\n    }\n\n    // Handle Buffer and typed arrays - don't serialize large binary data\n    if (typeof Buffer !== 'undefined' && Buffer.isBuffer(val)) {\n      return `[Buffer length=${val.length}]`;\n    }\n\n    if (ArrayBuffer.isView(val)) {\n      const ctor = (val as any).constructor?.name ?? 'TypedArray';\n      const byteLength = (val as any).byteLength ?? '?';\n      return `[${ctor} byteLength=${byteLength}]`;\n    }\n\n    if (val instanceof ArrayBuffer) {\n      return `[ArrayBuffer byteLength=${val.byteLength}]`;\n    }\n\n    // Handle objects - enforce key limit\n    const cleaned: Record<string, any> = {};\n    const entries = Object.entries(val);\n    let keyCount = 0;\n\n    for (const [key, v] of entries) {\n      if (keysToStrip.has(key)) {\n        continue;\n      }\n\n      if (keyCount >= maxObjectKeys) {\n        cleaned['__truncated'] = `${entries.length - keyCount} more keys omitted`;\n        break;\n      }\n\n      try {\n        cleaned[key] = helper(v, depth + 1);\n        keyCount++;\n      } catch (error) {\n        cleaned[key] = `[${error instanceof Error ? error.message : String(error)}]`;\n        keyCount++;\n      }\n    }\n\n    return cleaned;\n  }\n\n  return helper(value, 0);\n}\n\n/**\n * Bounded safe stringify for when you need JSON output.\n * Uses deepClean internally, then JSON.stringify with total length limit.\n *\n * @param value - The value to stringify\n * @returns A JSON string representation with enforced limits\n */\nexport function boundedStringify(value: unknown): string {\n  const cleaned = deepClean(value, { keysToStrip: NO_KEYS_TO_STRIP });\n\n  try {\n    const json = JSON.stringify(cleaned);\n    if (json.length > DEFAULT_SERIALIZATION_LIMITS.maxTotalChars) {\n      return json.slice(0, DEFAULT_SERIALIZATION_LIMITS.maxTotalChars) + '…[truncated]';\n    }\n    return json;\n  } catch {\n    return '[Not Serializable]';\n  }\n}\n"]}