'use strict';

var chunk3GJSIS6L_cjs = require('../chunk-3GJSIS6L.cjs');
var fs = require('fs');
var promises = require('fs/promises');
var module$1 = require('module');
var path = require('path');

var cache = /* @__PURE__ */ new Map();
function isBuiltinModule(specifier) {
  return module$1.builtinModules.includes(specifier) || specifier.startsWith("node:") || module$1.builtinModules.includes(specifier.replace(/^node:/, ""));
}
function isRelativePath(specifier) {
  return specifier.startsWith("./") || specifier.startsWith("../") || specifier.startsWith("/") || /^[a-zA-Z]:\\/.test(specifier);
}
async function getParentPath(specifier, url) {
  if (!cache.size) {
    let moduleResolveMapLocation = process.env.MODULE_MAP;
    if (!moduleResolveMapLocation) {
      moduleResolveMapLocation = path.join(process.cwd(), "module-resolve-map.json");
    }
    let moduleResolveMap = {};
    if (fs.existsSync(moduleResolveMapLocation)) {
      moduleResolveMap = JSON.parse(await promises.readFile(moduleResolveMapLocation, "utf-8"));
    }
    for (const [id, rest] of Object.entries(moduleResolveMap)) {
      cache.set(id, rest);
    }
  }
  const importers = cache.get(url);
  if (!importers) {
    return null;
  }
  const matchedPackage = Object.keys(importers).find((external) => chunk3GJSIS6L_cjs.isDependencyPartOfPackage(specifier, external));
  if (!matchedPackage) {
    return null;
  }
  const specifierParent = importers[matchedPackage];
  return specifierParent;
}
async function resolve(specifier, context, nextResolve) {
  if (isBuiltinModule(specifier)) {
    return nextResolve(specifier, context);
  }
  if (isRelativePath(specifier)) {
    return nextResolve(specifier, context);
  }
  if (context.parentURL) {
    const parentPath = await getParentPath(specifier, context.parentURL);
    if (parentPath) {
      return nextResolve(specifier, {
        ...context,
        parentURL: parentPath
      });
    }
  }
  return nextResolve(specifier, context);
}

exports.resolve = resolve;
//# sourceMappingURL=custom-resolver.cjs.map
//# sourceMappingURL=custom-resolver.cjs.map