{"version":3,"sources":["../src/build/utils.ts"],"names":["pathToFileURL","getPackageInfo","join","relative","basename"],"mappings":";;;;;;;AAeO,SAAS,yBAAA,CAA0B,KAAa,WAAA,EAAqB;AAC1E,EAAA,IAAI,QAAQ,WAAA,EAAa;AACvB,IAAA,OAAO,IAAA;AAAA,EACT;AAEA,EAAA,OAAO,GAAA,CAAI,UAAA,CAAW,CAAA,EAAG,WAAW,CAAA,CAAA,CAAG,CAAA;AACzC;AAKO,SAAS,eAAe,EAAA,EAAY;AACzC,EAAA,MAAM,KAAA,GAAQ,EAAA,CAAG,KAAA,CAAM,GAAG,CAAA;AAE1B,EAAA,IAAI,EAAA,CAAG,UAAA,CAAW,GAAG,CAAA,EAAG;AACtB,IAAA,OAAO,MAAM,KAAA,CAAM,CAAA,EAAG,CAAC,CAAA,CAAE,KAAK,GAAG,CAAA;AAAA,EACnC;AAEA,EAAA,OAAO,MAAM,CAAC,CAAA;AAChB;AAKA,eAAsB,kBAAA,CAAmB,aAAqB,UAAA,EAA6C;AACzG,EAAA,IAAI,QAAA;AAEJ,EAAA,IAAI;AACF,IAAA,IAAI,OAAA,GAA4C,MAAA;AAChD,IAAA,IAAI,UAAA,EAAY;AACd,MAAA,IAAI,CAAC,UAAA,CAAW,UAAA,CAAW,SAAS,CAAA,EAAG;AACrC,QAAA,UAAA,GAAaA,iBAAA,CAAc,UAAU,CAAA,CAAE,IAAA;AAAA,MACzC;AAEA,MAAA,OAAA,GAAU;AAAA,QACR,KAAA,EAAO,CAAC,UAAU;AAAA,OACpB;AAAA,IACF;AAEA,IAAA,MAAM,GAAA,GAAM,MAAMC,uBAAA,CAAe,WAAA,EAAa,OAAO,CAAA;AACrD,IAAA,QAAA,GAAW,KAAK,QAAA,IAAY,IAAA;AAAA,EAC9B,SAAS,CAAA,EAAG;AACV,IAAA,QAAA,GAAW,IAAA;AAAA,EACb;AAEA,EAAA,OAAO,QAAA;AACT;AAMO,SAAS,uBAAA,CAAwB,UAAkB,WAAA,EAAqB;AAC7E,EAAA,OAAO,MAAMC,SAAA,CAAK,QAAA,EAAU,cAAA,EAAgB,QAAA,EAAU,WAAW,CAAC,CAAA;AACpE;AAUO,SAAS,MAAM,IAAA,EAAc;AAClC,EAAA,MAAM,oBAAA,GAAuB,IAAA,CAAK,UAAA,CAAW,SAAS,CAAA;AAEtD,EAAA,IAAI,oBAAA,EAAsB;AACxB,IAAA,OAAO,IAAA;AAAA,EACT;AAEA,EAAA,OAAO,IAAA,CAAK,UAAA,CAAW,IAAA,EAAM,GAAG,CAAA;AAClC;AAKO,SAAS,cAAA,CAAe,MAAc,OAAA,EAAiB;AAC5D,EAAA,MAAM,GAAA,GAAMC,aAAA,CAAS,OAAA,EAAS,IAAI,CAAA;AAClC,EAAA,IAAI,KAAA,GAAQ,MAAM,GAAG,CAAA;AACrB,EAAA,KAAA,GAAQ,KAAA,CAAM,OAAA,CAAQ,YAAA,EAAc,EAAE,CAAA;AACtC,EAAA,KAAA,GAAQ,KAAA,CAAM,OAAA,CAAQ,MAAA,EAAQ,EAAE,CAAA;AAChC,EAAA,KAAA,GAAQ,KAAA,CAAM,OAAA,CAAQ,cAAA,EAAgB,EAAE,CAAA;AACxC,EAAA,IAAI,CAAC,KAAA,EAAO;AACV,IAAA,KAAA,GAAQ,KAAA,CAAMC,aAAA,CAAS,IAAI,CAAC,CAAA;AAAA,EAC9B;AACA,EAAA,OAAO,KAAA;AACT","file":"chunk-3GJSIS6L.cjs","sourcesContent":["import { execSync } from 'child_process';\nimport { existsSync, mkdirSync } from 'fs';\nimport { basename, join, relative } from 'path';\nimport { getPackageInfo } from 'local-pkg';\nimport { pathToFileURL } from 'url';\n\nexport function upsertMastraDir({ dir = process.cwd() }: { dir?: string }) {\n  const dirPath = join(dir, '.mastra');\n\n  if (!existsSync(dirPath)) {\n    mkdirSync(dirPath, { recursive: true });\n    execSync(`echo \".mastra\" >> .gitignore`);\n  }\n}\n\nexport function isDependencyPartOfPackage(dep: string, packageName: string) {\n  if (dep === packageName) {\n    return true;\n  }\n\n  return dep.startsWith(`${packageName}/`);\n}\n\n/**\n * Get the package name from a module ID\n */\nexport function getPackageName(id: string) {\n  const parts = id.split('/');\n\n  if (id.startsWith('@')) {\n    return parts.slice(0, 2).join('/');\n  }\n\n  return parts[0];\n}\n\n/**\n * Get package root path\n */\nexport async function getPackageRootPath(packageName: string, parentPath?: string): Promise<string | null> {\n  let rootPath: string | null;\n\n  try {\n    let options: { paths?: string[] } | undefined = undefined;\n    if (parentPath) {\n      if (!parentPath.startsWith('file://')) {\n        parentPath = pathToFileURL(parentPath).href;\n      }\n\n      options = {\n        paths: [parentPath],\n      };\n    }\n\n    const pkg = await getPackageInfo(packageName, options);\n    rootPath = pkg?.rootPath ?? null;\n  } catch (e) {\n    rootPath = null;\n  }\n\n  return rootPath;\n}\n\n/**\n * During `mastra dev` we are compiling TS files to JS (inside workspaces) so that users can just their workspace packages.\n * We store these compiled files inside `node_modules/.cache` for each workspace package.\n */\nexport function getCompiledDepCachePath(rootPath: string, packageName: string) {\n  return slash(join(rootPath, 'node_modules', '.cache', packageName));\n}\n\n/**\n * Convert windows backslashes to posix slashes\n *\n * @example\n * ```ts\n * slash('C:\\\\Users\\\\user\\\\code\\\\mastra') // 'C:/Users/user/code/mastra'\n * ```\n */\nexport function slash(path: string) {\n  const isExtendedLengthPath = path.startsWith('\\\\\\\\?\\\\');\n\n  if (isExtendedLengthPath) {\n    return path;\n  }\n\n  return path.replaceAll('\\\\', '/');\n}\n\n/**\n * Make a Rollup-safe name: pathless, POSIX, and without parent/absolute segments\n */\nexport function rollupSafeName(name: string, rootDir: string) {\n  const rel = relative(rootDir, name);\n  let entry = slash(rel);\n  entry = entry.replace(/^(\\.\\.\\/)+/, '');\n  entry = entry.replace(/^\\/+/, '');\n  entry = entry.replace(/^[A-Za-z]:\\//, '');\n  if (!entry) {\n    entry = slash(basename(name));\n  }\n  return entry;\n}\n\n/**\n * Native binding loaders and infrastructure packages that should be ignored when identifying the actual package that requires native bindings\n */\nconst NATIVE_BINDING_LOADERS = [\n  'node-gyp-build',\n  'prebuild-install',\n  'bindings',\n  'node-addon-api',\n  'node-pre-gyp',\n  'nan', // Native Abstractions for Node.js\n] as const;\n\n/**\n * Finds the first real package from node_modules that likely contains native bindings, filtering out virtual modules and native binding loader infrastructure.\n *\n * @param moduleIds - Array of module IDs from a Rollup chunk\n * @returns The module ID of the actual native package, or undefined if not found\n *\n * @example\n * const moduleIds = [\n *   '\\x00/path/node_modules/bcrypt/bcrypt.js?commonjs-module',\n *   '/path/node_modules/node-gyp-build/index.js',\n *   '/path/node_modules/bcrypt/bcrypt.js',\n * ];\n * findNativePackageModule(moduleIds); // Returns '/path/node_modules/bcrypt/bcrypt.js'\n */\nexport function findNativePackageModule(moduleIds: string[]): string | undefined {\n  return moduleIds.find(id => {\n    // Skip virtual modules (Rollup plugin-generated)\n    if (id.startsWith('\\x00')) {\n      return false;\n    }\n\n    // Must be from node_modules\n    if (!id.includes('/node_modules/')) {\n      return false;\n    }\n\n    // Skip native binding loader infrastructure\n    for (const loader of NATIVE_BINDING_LOADERS) {\n      if (id.includes(`/${loader}/`) || id.includes(`/${loader}@`)) {\n        return false;\n      }\n    }\n\n    return true;\n  });\n}\n"]}